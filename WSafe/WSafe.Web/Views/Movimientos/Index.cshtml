@model IEnumerable<WSafe.Web.Models.MovimientVM>

@{
    var title = "INFORMACIÓN BÁSICA DE LA EMPRESA";
}

<style>
    .tabGesMovimientos, .tabAddMovimientos {
        display: none;
    }
</style>

<hr />
<hr />
<h3 style="text-align:center"><strong>@Session["organization"].ToString().Trim()</strong></h3>

<div class="row">
    <div class="col-md-3">
        NÚMERO TRABAJADORES : @Session["numeroTrabajadores"].ToString().Trim()
    </div>
    <div class="col-md-5">
        HORARIO DE TRABAJO : @Session["turnoOperativo"].ToString().Trim()
    </div>
    <div class="col-md-2">
        PERIODO : @Session["year"].ToString().Trim()
    </div>
    <div class="col-md-2">
        CLASE RIESGO : @Session["riesgo"].ToString().Trim()
    </div>
</div>
<br />
<div class="pull-left">
    <div class="btn-group">
        <button type="button" class="btn btn-primary btn-lg" id="planear" title="doble click para cerrar la ventana">1. PLANEAR</button>
        <button type="button" class="btn btn-warning btn-lg" id="hacer" title="doble click para cerrar la ventana">2. HACER</button>
        <button type="button" class="btn btn-success btn-lg" id="verificar" title="doble click para cerrar la ventana">3. VERIFICAR</button>
        <button type="button" class="btn btn-danger btn-lg" id="actuar" title="doble click para cerrar la ventana">4. ACTUAR</button>
    </div>
</div>

@using (Html.BeginForm())
{
    @Html.AntiForgeryToken()

    <div class="form-horizontal">
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        <div class="tabAddMovimientos">
            @Html.Partial("_EditMovimient")
            <div class="row">
                <div class="col-md-8">
                    <hr />
                    <button type="button" id="btnAddMovimient" class="btn btn-primary" onclick="AddNewMovimient()">Adicionar</button>
                    <button type="button" id="btnCanMovimient" class="btn btn-primary" onclick="CancelMovimient()">
                        <span class="glyphicon glyphicon-chevron-left"></span> Cerrar
                    </button>
                </div>
                <div class="col-md-4">
                </div>
            </div>
        </div>

        <div class="tabGesMovimientos">
            <hr />
            <hr />
            <div class="col-md-12">
                <button type="button" class="btn btn-primary btn-lg" id="addMovimient">Subir archivo</button>
            </div>
            @Html.Partial("_ShowMovimientos")
        </div>

    </div>
}

@section Scripts
{
    <script src="~/Scripts/GestorRiesgosSST.js" type="text/javascript"></script>
    <script type="text/javascript">

        var ciclo = "";
        GestorMovimient();
        function CancelMovimient() {
            $(".tabAddMovimientos").css("display", "none");
            $("#txtStandardID").val("");
            $("#txtDescripcion").val("");
            $("#fileLoad").val("");
            $("#addMovimient").show();
        }

        function loadNormas(phva) {
            var selectedStandard = $("#txtStandardID").val();
            if (selectedStandard != null && selectedStandard != '') {
                $.getJSON('@Url.Action("GetNormas")', { ciclo: phva }, function (standards) {
                    if (standards != null && !jQuery.isEmptyObject(standards)) {
                        var html = '';
                        $.each(standards, function (index, item) {
                            html += '<option value = "' + item.Value + '">' + item.Text + '</option>';
                        });
                        $("#txtStandardID").html(html);
                    };
                });
            }
        }

        function AddNewMovimient() {
            // Crea un nuevo movimiento
            $(".tabAddMovimientos").css("display", "none");
            var selectedFile = ($("#fileLoad"))[0].files[0];
            if (!selectedFile) {
                alert("No se ha seleccionado ningún archivo para subir !!" + selectedFile);
                return false;
            }
            var dataFile = new FormData();
            dataFile.append("fileLoad", selectedFile);
            dataFile.append("NormaID", $("#txtStandardID").val());
            dataFile.append("Descripcion", $("#txtDescripcion").val());

            $.ajax({
                url: '@Url.Action("CreateMovimient","Movimientos")',
                type: "POST",
                data: dataFile,
                contentType: false,
                processData: false,
                async: false,
                success: function (response) {
                    $("#btnAddMovimient").hide();
                    $("#btnCanMovimient").hide();
                    $("#txtStandardID").val("");
                    $("#txtDescripcion").val("");
                    $(".tabAddMovimientos").css("display", "none");
                    $("#addMovimient").show();
                    alert(response.mensaj);
                    ShowMovimientos(ciclo);
                },
                error: function (xhr, ajaxOptions, thrownError) {
                    alert(xhr.status);
                    alert(thrownError);
                }
            });
        }

        $(document).ready(function () {
            ClearTextBox();
            $("#txtStandardID").focus();
        });

    </script>
}